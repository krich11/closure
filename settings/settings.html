<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings — Closure</title>
  <link rel="stylesheet" href="settings.css">
</head>
<body>
  <div class="settings-container">
    <header class="settings-header">
      <div class="header-brand">
        <img src="../icons/icon-48.png" alt="Closure Icon" class="header-logo">
        <h1>Settings</h1>
      </div>
      <p class="header-subtitle">Fine-tune how Closure cares for your tabs.</p>
    </header>

    <main>
      <!-- AI & Clustering -->
      <section class="settings-section" id="ai-section" aria-labelledby="section-ai">
        <h2 id="section-ai" class="section-title">AI Features</h2>
        <p class="section-desc">Closure uses Chrome's built-in Gemini Nano to summarize tabs before archiving them, and optionally to cluster your archived tabs by topic. Everything runs 100% on your device — no data ever leaves your machine.</p>

        <!-- Master AI Toggle -->
        <div class="field field-toggle ai-master-toggle">
          <label for="enable-ai" class="field-label">
            Enable AI
            <span class="field-hint">Master switch — powers all AI features: tab summaries, topic grouping, and thematic clustering. Requires a supporter code from <a href="https://ko-fi.com/s/28c3a8d852" target="_blank" rel="noopener">Ko-fi</a>.</span>
          </label>
          <button id="enable-ai" class="toggle" role="switch" aria-checked="false" type="button">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
          </button>
        </div>

        <!-- Supporter Code Gate (shown when toggling on without a stored code) -->
        <div id="ai-license-gate" class="ai-license-gate" hidden>
          <div class="license-gate-inner">
            <p class="license-gate-title">Supporter Code Required</p>
            <p class="license-gate-desc">AI features are a thank-you for supporters. Enter the code from your <a href="https://ko-fi.com/s/28c3a8d852" target="_blank" rel="noopener">Ko-fi</a> donation receipt to activate on-device intelligence. The code is stored locally and never transmitted.</p>
            <div class="license-input-row">
              <input type="text" id="ai-license-input" class="license-input" placeholder="CLOSURE-XXXXXXXX-XXXX" autocomplete="off" spellcheck="false" aria-label="Supporter code">
              <button id="ai-license-submit" class="btn btn-small" type="button">Activate</button>
            </div>
            <p id="ai-license-error" class="license-error" hidden></p>
          </div>
        </div>

        <!-- AI sub-controls (grayed out when AI is off) -->
        <div id="ai-sub-controls" class="ai-sub-controls ai-sub-controls--disabled">

        <div class="field field-toggle">
          <label for="enable-clustering" class="field-label">
            Thematic clustering
            <span class="field-hint">In Memory Lane, re-group archived tabs by topic instead of domain — e.g. tabs from different sites about "React performance" are clustered together</span>
          </label>
          <button id="enable-clustering" class="toggle" role="switch" aria-checked="false" type="button">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
          </button>
        </div>

        <div class="field field-toggle field-toggle--permission">
          <label for="enable-rich-analysis" class="field-label">
            Rich page analysis
            <span class="field-hint">Read page content for more accurate AI summaries and topic grouping. When disabled, Closure uses only tab titles and URLs. Enabling this grants Closure permission to read page content — Chrome will show a confirmation dialog.</span>
          </label>
          <button id="enable-rich-analysis" class="toggle" role="switch" aria-checked="false" type="button">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
          </button>
          <div id="rich-analysis-status" class="rich-analysis-status" role="status" aria-live="polite" hidden></div>
        </div>

        <div id="ai-status" class="ai-status" role="status" aria-live="polite"></div>
        <button id="ai-download-btn" class="btn btn-sm" hidden>Download AI Model</button>

        <details id="ai-setup-guide" class="ai-setup-guide" hidden>
          <summary class="ai-setup-summary">How to enable on-device AI</summary>
          <div class="ai-setup-steps">
            <p>Closure uses Chrome's built-in Gemini Nano model (requires Chrome 138+). No data leaves your device. To enable it:</p>
            <ol>
              <li>Open <a href="#" class="chrome-link" data-url="chrome://flags/#optimization-guide-on-device-model"><code>chrome://flags/#optimization-guide-on-device-model</code></a> and set it to <strong>Enabled BypassPerfRequirement</strong>.</li>
              <li>Open <a href="#" class="chrome-link" data-url="chrome://flags/#prompt-api-for-gemini-nano-multimodal-input"><code>chrome://flags/#prompt-api-for-gemini-nano-multimodal-input</code></a> and set it to <strong>Enabled</strong>.</li>
              <li><strong>Restart Chrome</strong> (quit completely with Cmd+Q and reopen).</li>
              <li>Open <a href="#" class="chrome-link" data-url="chrome://components"><code>chrome://components</code></a>, find <strong>Optimization Guide On Device Model</strong>, and click <strong>Check for update</strong> (downloads ~4 GB).</li>
              <li>Open <a href="#" class="chrome-link" data-url="chrome://on-device-internals"><code>chrome://on-device-internals</code></a>. Under <strong>Feature Adaptations</strong>, find <strong>kPromptApi</strong> and click <strong>"set to true"</strong>. Wait a minute for Chrome to download the adapter (its version will change from 0).</li>
              <li><strong>Restart Chrome again</strong> (Cmd+Q and reopen).</li>
              <li>Return here — the status above will show "available and ready."</li>
            </ol>
            <p class="ai-setup-note">Requires macOS 13+, 22 GB free disk space, and either a GPU with >4 GB VRAM or 16 GB RAM. This unlocks AI-powered tab summaries and thematic clustering. Everything runs 100% on your machine.</p>
          </div>
        </details>

        </div><!-- /ai-sub-controls -->
      </section>

      <!-- Auto-Grouping -->
      <section class="settings-section" aria-labelledby="section-grouping">
        <h2 id="section-grouping" class="section-title">Clean Slate Automator</h2>
        <p class="section-desc">When you open several tabs from the same site (e.g. 3 github.com tabs), they're automatically grouped and collapsed into a single labeled tab. Click the label to expand and see the tabs inside.</p>

        <div class="field">
          <label for="group-threshold" class="field-label">
            Group threshold
            <span class="field-hint">How many tabs from the same site before they're grouped (3–10)</span>
          </label>
          <input type="range" id="group-threshold" min="3" max="10" step="1" value="3" aria-valuemin="3" aria-valuemax="10">
          <output id="group-threshold-value" class="range-output" for="group-threshold">3</output>
        </div>

        <div class="field field-toggle">
          <label for="per-window-grouping" class="field-label">
            Per-window grouping
            <span class="field-hint">Only group tabs within the same window. When off, tabs from all windows are combined into a single group.</span>
          </label>
          <button id="per-window-grouping" class="toggle" role="switch" aria-checked="false" type="button">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
          </button>
        </div>

        <div class="ai-gated-control" id="topic-grouping-gate">
        <div class="field field-toggle">
          <label for="enable-topic-grouping" class="field-label">
            AI topic grouping
            <span class="field-hint">Periodically scan your ungrouped tabs and group them by topic using AI — e.g. a Stack Overflow answer, a blog post, and a GitHub issue about "React hooks" would be grouped together, even though they're from different sites.  This is helpful when performing research on a topic, as an example.</span>
          </label>
          <button id="enable-topic-grouping" class="toggle" role="switch" aria-checked="false" type="button">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
          </button>
        </div>

        <div id="topic-grouping-options" class="topic-grouping-options" hidden>
          <div class="field">
            <label for="topic-grouping-interval" class="field-label">
              Scan frequency
              <span class="field-hint">How often Closure scans your open tabs for topic clusters</span>
            </label>
            <select id="topic-grouping-interval" class="field-select">
              <option value="10">Every 10 minutes</option>
              <option value="15">Every 15 minutes</option>
              <option value="30">Every 30 minutes</option>
              <option value="60">Every hour</option>
              <option value="120" selected>Every 2 hours</option>
              <option value="240">Every 4 hours</option>
              <option value="480">Every 8 hours</option>
              <option value="720">Every 12 hours</option>
              <option value="1440">Every 24 hours</option>
            </select>
          </div>

          <div class="field field-toggle">
            <label for="topic-grouping-overnight" class="field-label">
              Overnight only
              <span class="field-hint">Run topic grouping once a day at 2 AM instead of on a schedule — the scan frequency above is ignored</span>
            </label>
            <button id="topic-grouping-overnight" class="toggle" role="switch" aria-checked="false" type="button">
              <span class="toggle-track"><span class="toggle-thumb"></span></span>
            </button>
          </div>
        </div>
        </div><!-- /ai-gated-control -->
      </section>

      <!-- Graceful Exit -->
      <section class="settings-section" aria-labelledby="section-idle">
        <h2 id="section-idle" class="section-title">Graceful Exit</h2>
        <p class="section-desc">Tabs you haven't touched in a while are archived: their content is summarized by on-device AI, then the tab is closed. You'll get a "Stay of Execution" warning 10 minutes before, and everything is saved to Memory Lane.</p>

        <div class="field">
          <label for="idle-threshold" class="field-label">
            Idle threshold
            <span class="field-hint">Hours of inactivity before a tab is archived (4–168, i.e. up to 1 week)</span>
          </label>
          <input type="range" id="idle-threshold" min="4" max="168" step="4" value="24" aria-valuemin="4" aria-valuemax="168">
          <output id="idle-threshold-value" class="range-output" for="idle-threshold">24h</output>
        </div>
      </section>

      <!-- Memory Lane -->
      <section class="settings-section" aria-labelledby="section-memory-lane">
        <h2 id="section-memory-lane" class="section-title">Memory Lane</h2>
        <p class="section-desc">Your archive of all closed tabs with summaries. Configure how long entries are kept and how they're sorted by default.</p>

        <div class="field">
          <label for="retention-days" class="field-label">
            Archive retention
            <span class="field-hint">Automatically delete archived entries older than this. Set to "Forever" to keep everything.</span>
          </label>
          <input type="range" id="retention-days" min="0" max="365" step="1" value="0" aria-valuemin="0" aria-valuemax="365">
          <output id="retention-days-value" class="range-output" for="retention-days">Forever</output>
        </div>

        <div class="field">
          <label for="archive-sort" class="field-label">
            Default sort order
            <span class="field-hint">How archived tabs are sorted when you open Memory Lane</span>
          </label>
          <select id="archive-sort" class="field-select">
            <option value="recency">Most recent first</option>
            <option value="domain">By domain (A–Z)</option>
          </select>
        </div>
      </section>

      <!-- Whitelist -->
      <section class="settings-section" aria-labelledby="section-whitelist">
        <h2 id="section-whitelist" class="section-title">Whitelist</h2>
        <p class="section-desc">Domains listed here are completely hands-off — Closure won't group, sweep, or archive any tab from these sites. Subdomains are automatically covered (e.g. whitelisting <code>github.com</code> also protects <code>gist.github.com</code>). Drag to reorder.</p>

        <div class="field">
          <label for="whitelist-input" class="field-label sr-only">Add domain to whitelist</label>
          <div class="whitelist-input-row">
            <input type="text" id="whitelist-input" placeholder="example.com, localhost, 192.168.1.1" autocomplete="off" spellcheck="false">
            <button id="whitelist-add" class="btn btn-small" type="button" aria-label="Add domain to whitelist">Add</button>
          </div>
          <p id="whitelist-error" class="whitelist-error" hidden></p>
        </div>

        <ul id="whitelist-entries" class="whitelist-list" aria-label="Whitelisted domains">
          <!-- Dynamically populated -->
        </ul>

        <p id="whitelist-empty" class="whitelist-empty">No domains whitelisted yet.</p>
      </section>

      <!-- Accessibility -->
      <section class="settings-section" aria-labelledby="section-a11y">
        <h2 id="section-a11y" class="section-title">Accessibility</h2>

        <div class="field field-toggle">
          <label for="high-contrast" class="field-label">
            High-contrast mode
            <span class="field-hint">Boosts text and UI contrast across all Closure pages for better readability</span>
          </label>
          <button id="high-contrast" class="toggle" role="switch" aria-checked="false" type="button">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
          </button>
        </div>
      </section>

      <!-- Incognito Warning -->
      <section id="incognito-section" class="settings-section settings-section--warning" aria-labelledby="section-incognito" hidden>
        <h2 id="section-incognito" class="section-title">Incognito Mode</h2>
        <div class="warning-banner" role="alert">
          <p><strong>Warning:</strong> Closure is enabled in incognito mode. While Closure never transmits data, archived tab records from incognito windows will be stored locally alongside your regular browsing data.</p>
          <p>Disable incognito access in <code>chrome://extensions</code> if this concerns you.</p>
        </div>
      </section>

      <!-- Storage Management -->
      <section class="settings-section" aria-labelledby="section-storage">
        <h2 id="section-storage" class="section-title">Storage</h2>
        <p class="section-desc">Manage data stored locally by Closure. Nothing is ever sent to the cloud.</p>
        <button id="clear-storage-btn" class="btn btn-small btn-outline" type="button">Clear Storage…</button>
        <button id="zeroize-btn" class="btn btn-small btn-danger" type="button" hidden>Zeroize…</button>
      </section>

      <!-- Debug -->
      <section class="settings-section" aria-labelledby="section-debug">
        <h2 id="section-debug" class="section-title">Debug</h2>
        <p class="section-desc">Developer tools for testing and troubleshooting. These add extra buttons and controls to Closure’s UI that are not shown to regular users.</p>

        <div class="field field-toggle">
          <label for="enable-debug" class="field-label">
            Enable debug tools
            <span class="field-hint">Shows a Re-summarize button on each archived card in Memory Lane, and other diagnostic controls</span>
          </label>
          <button id="enable-debug" class="toggle" role="switch" aria-checked="false" type="button">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
          </button>
        </div>
      </section>

      <!-- Clear Storage Dialog -->
      <dialog id="clear-storage-dialog" class="storage-dialog" aria-labelledby="dialog-title">
        <div class="dialog-content">
          <h2 id="dialog-title" class="dialog-title">Clear Storage</h2>
          <p class="dialog-desc">Select what to clear. This action cannot be undone.</p>

          <ul class="storage-category-list">
            <li class="storage-category">
              <label>
                <input type="checkbox" name="clear-cat" value="archived" checked>
                <span class="storage-cat-name">Archived tabs</span>
                <span id="size-archived" class="storage-cat-size">calculating…</span>
              </label>
            </li>
            <li class="storage-category">
              <label>
                <input type="checkbox" name="clear-cat" value="swept" checked>
                <span class="storage-cat-name">Swept tab log</span>
                <span id="size-swept" class="storage-cat-size">calculating…</span>
              </label>
            </li>
            <li class="storage-category">
              <label>
                <input type="checkbox" name="clear-cat" value="stats" checked>
                <span class="storage-cat-name">Statistics</span>
                <span id="size-stats" class="storage-cat-size">calculating…</span>
              </label>
            </li>
            <li class="storage-category">
              <label>
                <input type="checkbox" name="clear-cat" value="config">
                <span class="storage-cat-name">Settings &amp; whitelist</span>
                <span id="size-config" class="storage-cat-size">calculating…</span>
              </label>
            </li>
          </ul>

          <p id="storage-total" class="storage-total">Total storage used: calculating…</p>

          <div class="dialog-actions">
            <button id="clear-storage-cancel" class="btn btn-small btn-outline" type="button">Cancel</button>
            <button id="clear-storage-confirm" class="btn btn-small btn-danger" type="button">Clear Selected</button>
          </div>
        </div>
      </dialog>

      <!-- Save / Status -->
      <div class="settings-actions">
        <div id="save-status" class="save-status" role="status" aria-live="polite"></div>
      </div>
    </main>

    <footer class="settings-footer">
      <p>Closure v2.0.5 — 100% local, 100% private.</p>
    </footer>
  </div>

  <script src="settings.js"></script>
</body>
</html>
