# Copilot Instructions — Test Suite

## Running Tests During Development

- **Use minimal, targeted test runs.** When verifying a code change, run only the specific spec file(s) affected — e.g., `npx playwright test tests/settings.spec.js`. Do not run the full suite unless the user explicitly asks for it.
- **Never run `@slow` tests** unless the user specifically requests them.
- **Never run `test:all`** unless the user specifically requests a full test run.
- The user will tell you when a full or slow test run is warranted. Default to fast, focused validation.

## Test Tagging

Tests are categorized by speed using tags in `test.describe()` names:

- **`@slow`** — Tests that depend on real Chrome alarms (30–47s each) or create multiple tabs navigating to external URLs. These are excluded from the default `npm test` run.
- **No tag** — Fast tests (1–3s each) that run against extension pages, storage, or chrome APIs without waiting on alarms or external navigation.

## NPM Scripts

| Command | What it runs |
|---|---|
| `npm test` | Default suite — all tests **except** `@slow` (~97 tests, ~2.5 min) |
| `npm run test:slow` | Only `@slow`-tagged tests (~14 tests, ~5 min) |
| `npm run test:all` | Everything including `@slow` (~111 tests, ~7 min) |

## How Tagging Works

The default `playwright.config.js` uses `grepInvert: /@slow/` to skip slow tests. The `playwright.all.config.js` overrides this to `undefined` so all tests run.

To tag a test as slow, append `@slow` to the `test.describe()` name:

```js
test.describe('Feature Name @slow', () => { ... });
```

## Currently Tagged `@slow`

- `auto-grouping.spec.js` — Opens 3+ tabs to external URLs, waits for tab grouping events.
- `dead-end-sweeper-integration.spec.js` — Fires real `chrome.alarms` (minimum ~30s delay), polls storage for sweep results. Sets `test.setTimeout(120_000)`.

## When to Tag a New Test `@slow`

Tag it `@slow` if it:
- Waits for a real `chrome.alarms` alarm to fire (minimum ~30s in Chrome).
- Polls in a loop for >10 seconds waiting on async browser behavior.
- Navigates multiple tabs to external HTTP URLs (flakiness risk).

Do **not** tag a test `@slow` if it only:
- Uses `waitForTimeout` under 3 seconds for UI settling.
- Manipulates `chrome.storage.local` directly.
- Navigates to `chrome-extension://` pages.
